<html>

<head>
	<style>

		body {
			color: #444;
			font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, sans-serif;
			font-weight: 200;
			margin: 0;
			padding: 20px;
		}

		h1 {
			margin: 0px 0px 10px 0px;
		}

		div#controls {
			display: inline-block;
		}

		select {
			width: 150px;
		}

		table {
			border-collapse: collapse;
			font-size: 12px;
		}

		th {
			background-color: #444;
			color: white;
      text-align: left;
		}

		tr:nth-child(odd) {
			background-color: #ddd;
		}

		td, th {
			padding: 5px 7px;
		}

		div#downloadLink a {
			background-color: green;
			color: white;
			display: inline-block;
			margin: 10px 0px;
			padding: 5px 7px;
			text-decoration: none;
		}

		.container {
			float:left;
			margin-right:20px;
		}

		input {
			display:block;
      margin: 5px 0;
		}
		label {
			display:block;
		}

		.controls {
			float:left;
		}

	</style>
	<script src="/static/js/libs/jquery-2.0.3.min.js"></script>
</head>

<body>
<h1>{{ dataset }} data viewer</h1>
<form>

<div id="controls">

	<div class="container">
		<label>Year</label>
		<select name="year">

		{% for x in range(14) %}
		<option id="{{ 2013-x }}" value="{{ 2013-x }}"  >{{2013-x}}
		</option>
		{% endfor %}
		</select>

	</div>
</div>
<br/>
<input type="submit"/>

</form>




<div href="" id="downloadLink"></div>
<table id="datatable"></table>


<script>
var dataset = '{{dataset}}';
var body = document.body;
var attrsMap = {};
var ATTRS_URL = '/static/json/workshop_attrs.json';

var headerMap = {
	"bra_id" : "bra",
	"bra_id_r" : "bra",
	"bra_id_s" : "bra",
	"cnae_id": "cnae",
	"cnae_id_r": "cnae",
	"cnae_id_s": "cnae",
	"wld_id" : "wld",
	"cbo_id" : "cbo",
	"hs_id" : "hs",
	// "university_id" : "inst",
	"grade_id" : "grade",
	"course_sc_id" : "course",
	"ethnicity_id" : "ethnicity"
}

var datasetMap = {
	'ei' : ['bra', 'cnae', 'bra', 'cnae', 'hs'],
	'secex' : ['bra', 'hs', 'wld'],
	'rais' : ['bra', 'cbo', 'cnae'],
	'hedu' : ['bra', 'inst', 'course'],
	'sc' : ['bra', 'grade', 'ethnicity']
}

var show_map = {
	"bra" : [
		["states", 2],
		["mesoregions", 4],
		["municipalities", 8]
	],
	"hs" :  [
		["sections", 2],
		["chapters", 4],
		["positions", 6]
	],
	"cnae" : [
		["sections", 1],
		["divisions", 3],
		["classes", 6]
	],
	"cbo" : [
		["main groups", 1],
		["principles", 2],
		["families", 4]
	]
}

var explainMap = {
	"bra" : "Location",
	"hs": "Product",
	"cnae" : "Industry",
	"cbo": "Occupation",
	"inst": "Institution",
	"grade" : "Grade",
	"ethnicity": "Ethnicity",
	"course" :"Course"
}

function setupQuickMap(data) {
	myMap = {};

	for (var key in data) {
		var list = data[key];
		var pos = list.length - 1;
		myMap[key] = {};
		while (pos--) {
			var obj = list[pos];
			myMap[key][obj.id] = obj.name ;
		}
	}
	return myMap;
}

function setAttrs(data) {
	attrsMap = setupQuickMap(data);
	var year = 2013;
	if (dataset === 'rais') year = 2002;
	else if (dataset === 'hedu' || dataset === 'sc') year = 2012;
	document.getElementById(year).selected = true;
	var columns = datasetMap[dataset];
	for (var i in columns) {
		var col = columns[i];

		var url = "/" + dataset + "/" + year + "/"; //<0>/<1>/<2>/<3>/<4>/?id";

		for (var j = 0; j < columns.length; j++) {
			var text = (i==j) ? "show" : "all";
			url += text + "/";
		}
		url += "?id";
		console.log("URL", url);
		getJson(col, url, addDropdown);
	}
}

function addAggShows(label, select) {
	if (label in show_map) {
		var nesting = show_map[label];

		for (var i in nesting) {
			var name = nesting[i][0];
			var depth = nesting[i][1];
			var show = new Option();
			show.value = 'show.' + depth;
			show.text = 'Show ' + name;
			select.options.add(show);
		}
	}
}

function addDropdown(label, data, headers) {
	var controls = document.getElementById("controls");

	var selectContainer = document.createElement("div");
	selectContainer.className = "container";
	var labelElem = document.createElement("label");
	var labelTxt = label;
	if (label in explainMap) labelTxt = explainMap[labelTxt];
	labelElem.innerText = labelTxt;


	var select = document.createElement("select");
	select.name = label;
	var all = new Option();
	all.value = 'all';
	all.text = 'All';

	var show = new Option();

	show.value = 'show';
	show.text = 'Show All';

	select.options.add(all);
	select.options.add(show);

	addAggShows(label, select);

	var options = [];

	for (var i in data) {
		var op = new Option();
		op.value = data[i][0];

		var name = attrsMap[label][data[i][0]];
		if (name == undefined) continue;
		op.text = name;
		options.push(op);
	}


	// alphabetical sort
	options.sort(function(a,b) {
	    if (a.text > b.text) return 1;
	    else if (a.text < b.text) return -1;
	    else return 0
	});

	$(select).append(options);

	selectContainer.appendChild(labelElem);
	selectContainer.appendChild(select);
	controls.appendChild(selectContainer);

	return 1;
}



function getJson(label, url, callback) {
	var request = new XMLHttpRequest();
	request.open('GET', url, true);

	request.onload = function() {
	  if (request.status >= 200 && request.status < 400){
	    // Success!
	    var data = JSON.parse(request.responseText);
	    if (label === 'attrs') {
	    	callback(data);
	    } else {
	    	if (label === 'hs') console.log("hs",data);
		    callback(label, data.data, data.headers);
		}
	  } else {
	    // We reached our target server, but it returned an error
	    console.warn("Bad status");
	  }
	};

	request.onerror = function() {
		// There was a connection error of some sort
	};
	request.send();
}

function resetTable() {
	var table = document.getElementById("datatable");
	table.innerHTML = "Loading...";

	var downloadLink = document.getElementById("downloadLink");
	downloadLink.innerHTML = "";
	return table;
}

function doQuery() {
	event.preventDefault();

	var table = resetTable();

	var selects = $("select");
	var qurl = "/" + dataset + "/";
	for (var k =0; k < selects.length; k++) {
		qurl += selects[k].value +"/";
	}

	console.log("custom url", qurl);
	var check = qurl.split("show");
	if (check.length != 2) {
		table.innerHTML = "Please show one column.";
		return;
	}

	getJson("data", qurl, populateTable);
}

function makeRow(list, headers) {
	var tdiv = headers ? "td" : "th";
	var tr = document.createElement("tr");

	for (var i in list) {
		var td = document.createElement(tdiv);
		var rawId = list[i];

		td.innerText = rawId;
		tr.appendChild(td);

		if (headers) {
			var attr = headers[i];
			if (attr != undefined && attr in headerMap) {
				var text = attrsMap[headerMap[attr]][rawId];
				var td2 = document.createElement("td");
				td2.innerText = text;
				tr.appendChild(td2);
			}
		}
		else if (!headers && rawId in headerMap) {
			var td2 = document.createElement("th");
			td2.innerText = rawId;
			tr.appendChild(td2);
		}

	}
	return tr;
}

function makeHeaders(headers) {
	var thead = document.createElement("thead");
	var row = makeRow(headers);
	thead.appendChild(row);
	return thead;
}

function populateTable(label, data, headers) {
	console.log("HEADERS", headers);

	var table = document.getElementById("datatable");
	table.innerHTML = "";
	if (data.length == 0) {
		table.innerHTML = "No data";
		return;
	}
	table.appendChild( makeHeaders(headers) );

	for (var i in data) {

		table.appendChild( makeRow(data[i], headers) );
	}

	makeCSV();
}

function start() {
	getJson("attrs", ATTRS_URL, setAttrs);

	$("form").submit(doQuery);
}

// Via http://jsfiddle.net/5KRf6/3/
function makeCSV() {
	var sep = ",";
    var csv = "";
    var first = true;
    $("table").find("tr").each(function () {
        var sep = "";
        $(this).find(first ? "th" : "td").each(function () {
            csv += sep + this.innerHTML;
            // console.log(this);
            sep = ",";
        });
        csv += "\n";
        first = false;
    });

    window.URL = window.URL || window.webkiURL;
    var blob = new Blob([csv]);
    var blobURL = window.URL.createObjectURL(blob);
    $("#downloadLink").html("");
    $("<a></a>").
    	attr("href", blobURL).
    	attr("download", "data.csv").
    	text("Download Data").
    	appendTo('#downloadLink');
}

$(document).ready(start);

</script>

</body>
</html>
